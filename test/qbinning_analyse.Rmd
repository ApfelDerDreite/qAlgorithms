---
title: "Analysis qbinning"
author: "Daniel Höhn"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# knitr::opts_knit$set(root.dir = "G:/_Studium/Analytik-Praktikum/qbinning")
library(tidyverse)
library(data.table)
library(patchwork)
```

```{r new bin}
monobin = read.csv("../../rawdata/monobin_base.csv")
monobin = monobin[which(1912 < monobin$scans & monobin$scans < 1958),]

# erstelle je 1 Eintrag für alle scans zwischen 1913 und 1957
for (i in 1913:1957) {
  r = runif(1, 2, 4)
  a = c(55*r, r*r/1000000, runif(1, 700, 2000), i, 1, -1, 0, -1)
  monobin = rbind(monobin, a)
}
for (i in 1:length(monobin$mz)) {
  t1 = c(monobin$mz[i]*runif(1, 2, 3), monobin$error[i], NA, monobin$scans[i], 1, -1, 0, -1)
  t2 = c(monobin$mz[i]*runif(1, 2, 4), monobin$error[i], NA, monobin$scans[i], 1, -1, 0, -1)
  monobin = rbind(monobin, t1)
  monobin = rbind(monobin, t2)
}
monobin$rt = monobin$scans * 0.65
monobin = monobin[with(monobin, order(scans, mz)), ]

# write.csv(monobin, "../../rawdata/monobin.csv", row.names = FALSE)

# für R:
monoR = read.csv("../../rawdata/monobin.csv")[,-8]
write.csv(monoR, "../../rawdata/monobinForR.csv", row.names = FALSE)

```

```{r artificial bin}
artmz = rep(c(200,300,400), each = 10)
artmz = artmz + runif(30, 0.0001, 0.0009)
arterror = artmz * 0.000005
artscan = c(1:10, 6:15, 11:20)

artbin = data.frame(mz = artmz, error = arterror, rt = NA, scans = artscan, intensity = 1, ID = c(rep(1:3, each = 10)), DQScen = 0.99, DQSbin = 0.99)

out1 = c(215, 0.001, NA, 2, 1, 0, 0.1, 0.1)
out2 = c(300.5, 0.0015, NA, 20, 1, 0, 0.1, 0.1)

artbin = rbind(artbin, out1, out2)
artbin$rt = 0.65 * artbin$scans + 1

# write.csv(artbin, "../../rawdata/artbin.csv", row.names = FALSE)
```



```{r bin results}
qbins <- read.csv("../../qbinning_binlist.csv")
accurate = c(1:16)

for (i in 0:15) {
  accurate[i+1] = sum((round(qbins$DQS - qbins$control_DQSB, digits = i) == 0))
}

plot(c(0:15), accurate/length(qbins$mz))
plot(c(0:15), cumsum(accurate))

qbins$DQSacc = qbins$DQS - qbins$control_DQSB

plot(round(qbins$control_DQSB, digits = 3), round(qbins$DQS, digits = 3))

```

```{r control notbinned}
# outliers should be normally distributed throughout the dataset
notbinned = read.csv("../../qbinning_notbinned.csv")[,1:2]

```

```{r control median of mz}
medianMZ = read.csv("../../qbins_tvals.csv")
medianMZ$critTval = qt(0.05, medianMZ$n, lower.tail = FALSE)
medianMZ$check = medianMZ$critTval - medianMZ$tval
sum(medianMZ$check < 0)
hist(log10(medianMZ$n[which(medianMZ$check < 0)])) # no strict correlation between binsize, dqs and the median being a bad estimate of the distribution mean
```

```{r merge}
prebinned <- read.csv("../../rawdata/control_bins_base.csv")
rawdata <- read.csv("../../rawdata/qCentroid_Warburg_pos_171123_01_Zu_01.csv")
prebinned$mzError <- rawdata$Centroid.Error
#mz column, centroid error column, RT column, scan number column, control ID column 
export <- data.frame(mz = prebinned$mz, mzError = prebinned$mzError, RT = prebinned$rt, scanNo = prebinned$scanNo, intensity = prebinned$intensity, controlID = prebinned$ID, controlCentroidDQS = prebinned$DQScen, controlBinDQS = prebinned$DQSbin)

write.csv(export, "../../rawdata/control_bins_full.csv", row.names = FALSE)
getwd()
```

```{r worst dqs possible}
worstDQS <- function(n, mz){
  vcrit = 3.05037165842070 * log(n)^(-0.4771864667153) * mz * 5 * 10^-6 # assumes 5ppm error
  # assuming MOD is equal to vcrit
  
  
}


```

