---
title: "Analysis qbinning"
author: "Daniel HÃ¶hn"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# knitr::opts_knit$set(root.dir = "G:/_Studium/Analytik-Praktikum/qbinning")
library(tidyverse)
library(data.table)
library(patchwork)
```

```{r bin results}
qbins <- read.csv("../../process_comparison/maxdist6_binlist.csv")
nobins <- read.csv("../../process_comparison/maxdist6_notbinned.csv")

sum(nobins$control_ID != -1)
sum(qbins$control_ID == -1)
sum((round(qbins$DQS - qbins$control_DQSB, digits = 10) == 0))
difflevelsDQS <- data.frame(digits = c(1:10),
                            matching = c(2032619, 1740838, 1190492, 794114, 454395, 313191, 289840, 286934, 286397, 250458))
plot(difflevelsDQS$matching/length(qbins$mz)) # reaches stable level at 6 digits

plot(nobins$mz[which(nobins$control_ID != -1)], nobins$scan[which(nobins$control_ID != -1)])
plot(qbins$mz[which(qbins$control_ID == -1)], qbins$scan[which(qbins$control_ID == -1)])

mean(qbins$DQS)
mean(qbins$DQS[which(qbins$control_ID == -1)])
```

```{r steps per bin}
getwd()
qbins <- read.csv("../../qBinning_binposition.csv")
qbins$index <- c(1:length(qbins$mzmin))

ggplot(qbins)+
  geom_rect(aes(xmin = scanmin, xmax = scanmax, ymin = mzmin, ymax = mzmax, colour = index))
```


```{r}
binstats <- read.csv("binstats.csv")
hist(log(binstats$time.DQSB.))
plot(binstats$size, binstats$time.DQSB.)
plot(binstats$mean.scans., -binstats$scanRange/binstats$size)
plot(binstats$mean.mz., log(-binstats$scanRange/binstats$size))
plot(log(binstats$time.DQSB.), binstats$mean.DQS.)
```


```{r reformat}
bins <- read.csv("C:/Users/unisys/Documents/Studium/Analytik-Praktikum/rawdata/df_qBinning_test.csv")

bins <- bins[order(bins$rt),]
bins$scanNo <- c(1,ceiling(diff(bins$rt)))
bins$scanNo <- cumsum(bins$scanNo)
last(bins$scanNo)

write.csv(bins, file = "control_bins_full.csv", row.names = FALSE)
```

```{r merge}
prebinned <- read.csv("../../rawdata/control_bins_base.csv")
rawdata <- read.csv("../../rawdata/qCentroid_Warburg_pos_171123_01_Zu_01.csv")
prebinned$mzError <- rawdata$Centroid.Error
#mz column, centroid error column, RT column, scan number column, control ID column 
export <- data.frame(mz = prebinned$mz, mzError = prebinned$mzError, RT = prebinned$rt, scanNo = prebinned$scanNo, intensity = prebinned$intensity, controlID = prebinned$ID, controlCentroidDQS = prebinned$DQScen, controlBinDQS = prebinned$DQSbin)

write.csv(export, "../../rawdata/control_bins_full.csv", row.names = FALSE)
getwd()
```

